<!DOCTYPE html>
<html>
<head>
    <style>
        body { background: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #header { padding: 15px; background: #1e1e1e; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; }
        #chat-box { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }
        
        /* Message Styling */
        .msg { background: #2d2d2d; padding: 10px 14px; border-radius: 12px; width: fit-content; max-width: 85%; position: relative; border-bottom-left-radius: 2px; }
        .msg-info { display: flex; justify-content: space-between; align-items: baseline; gap: 15px; margin-bottom: 4px; }
        .msg b { color: #007bff; font-size: 0.85rem; }
        .timestamp { color: #888; font-size: 0.65rem; font-weight: normal; }
        
        #input-area { padding: 15px; background: #1e1e1e; display: flex; gap: 10px; border-top: 1px solid #333; }
        input { flex-grow: 1; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #262626; color: white; outline: none; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #0056b3; }
        #online-tag { background: #28a745; color: white; padding: 5px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
    </style>
</head>
<body>

<div id="header">
    <span id="online-tag">Online: <span id="count">1</span></span>
    <button onclick="changeName()" style="background: #444; font-size: 0.8rem;">Edit Nickname</button>
</div>

<div id="chat-box"></div>

<div id="input-area">
    <input type="text" id="msg-input" placeholder="Say something..." onkeypress="if(event.key==='Enter') send()">
    <button onclick="send()">Send</button>
</div>

<script src="https://cdn.ably.com/lib/ably.min-1.js"></script>

<script>
    // 1. CONNECTION (Replace Key if you rotated it)
    const ably = new Ably.Realtime('EEkkWA.G6icog:T0iJzeqrPkW15N9A7JANivEDFWkKrTp2XmPlXoAzSS4');
    const channel = ably.channels.get('school-chat');

    // 2. NICKNAME PERSISTENCE
    let myName = localStorage.getItem('chat-name') || "Player" + Math.floor(Math.random() * 999);
    
    function changeName() {
        let n = prompt("Change your display name:", myName);
        if(n && n.trim().length > 0) {
            myName = n;
            localStorage.setItem('chat-name', n);
        }
    }

    // 3. SEND MESSAGE WITH TIMESTAMP
    function send() {
        const input = document.getElementById('msg-input');
        if(input.value.trim() === "") return;

        // Getting current time in 12h format
        const timeNow = new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });

        channel.publish('message', {
            user: myName,
            text: input.value,
            time: timeNow
        });
        input.value = "";
    }

    // 4. RECEIVE MESSAGE & AUTO-SCROLL
    channel.subscribe('message', (msg) => {
        const chatBox = document.getElementById('chat-box');
        const msgDiv = document.createElement('div');
        msgDiv.className = 'msg';
        
        msgDiv.innerHTML = `
            <div class="msg-info">
                <b>${msg.data.user}</b>
                <span class="timestamp">${msg.data.time}</span>
            </div>
            <div>${msg.data.text}</div>
        `;
        
        chatBox.appendChild(msgDiv);
        
        // Auto-scroll to the bottom (Limit behavior)
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    // 5. REAL-TIME PRESENCE (Online Count Fix)
    channel.presence.enter();

    function updateCount() {
        channel.presence.get((err, members) => {
            if (!err) document.getElementById('count').innerText = members.length;
        });
    }

    // Subscribe to all presence events to update count immediately
    channel.presence.subscribe(['enter', 'leave', 'update'], () => updateCount());
    
    // Initial update when page first loads
    updateCount();

</script>
</body>
</html>